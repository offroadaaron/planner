{% extends "base.html" %}
{% block content %}
<section class="card">
  <h1>CVM {{ year }}</h1>
  <form method="get" action="/cvm" class="grid">
    <input type="number" min="2000" max="2100" name="year" value="{{ year }}" />
    <select name="territory_id">
      <option value="">All Territories</option>
      {% for t in territories %}
      <option value="{{ t.id }}" {% if territory_id == t.id %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
    <button type="submit">Load CVM</button>
  </form>
</section>

<section class="card table-scroll">
  <table class="matrix-table">
    <thead>
      <tr>
        <th>Territory</th>
        <th>Cust Code</th>
        <th>SORT</th>
        <th>Customer Name</th>
        <th>Trade Name</th>
        <th>Notes/Comments</th>
        <th>Last Completed</th>
        <th>Total Planned</th>
        <th>Total Completed</th>
        {% for m in months %}
          <th>{{ m }} Date / Done</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.territory }}</td>
        <td>{{ r.cust_code }}</td>
        <td>{{ r.sort_bucket }}</td>
        <td>{{ r.customer_name }}</td>
        <td>{{ r.trade_name }}</td>
        <td>
          <form method="post" action="/cvm/notes-update" class="cvm-notes-form" autocomplete="off">
            <input type="hidden" name="customer_id" value="{{ r.id }}" />
            <input type="hidden" name="year" value="{{ year }}" />
            <input type="hidden" name="territory_id" value="{{ territory_id or '' }}" />
            <textarea name="notes" rows="3" placeholder="Notes/Comments">{{ r.cvm_notes or '' }}</textarea>
            <button type="submit">Save Notes</button>
          </form>
        </td>
        <td>{{ r.last_completed or '' }}</td>
        <td>{{ r.planned_total }}</td>
        <td>{{ r.completed_total }}</td>
        {% for i in range(1, 13) %}
          {% set cell = r.month_data.get(i) %}
          <td>
            <form method="post" action="/cvm/month-update" class="cvm-month-form" autocomplete="off">
              <input type="hidden" name="customer_id" value="{{ r.id }}" />
              <input type="hidden" name="year" value="{{ year }}" />
              <input type="hidden" name="month" value="{{ i }}" />
              <input type="hidden" name="territory_id" value="{{ territory_id or '' }}" />
              <input type="date" name="planned_date" value="{{ cell.planned_date if cell else '' }}" />
              <label class="cvm-check">
                <input type="checkbox" name="completed_manual" value="1" {% if cell and cell.completed_manual %}checked{% endif %} />
                Done
              </label>
              <button type="submit">Save</button>
            </form>
          </td>
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="21">No customer rows available yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
