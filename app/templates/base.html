<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#eef3fb" />
    <title>Calendar Planner</title>
    <script>
      (() => {
        const key = "planner.theme";
        let stored = null;
        try {
          stored = window.localStorage.getItem(key);
        } catch (_) {}
        const theme = stored === "dark" || stored === "light" ? stored : "dark";
        document.documentElement.setAttribute("data-theme", theme);
        document.documentElement.classList.toggle("dark", theme === "dark");
      })();
    </script>
    <link rel="stylesheet" href="/static/styles.css" />
    {% block head_extra %}{% endblock %}
  </head>
  <body class="app-body">
    <div class="app-shell">
      <header class="app-header">
        <div class="app-header-inner">
          <a href="/" class="brand-link" aria-label="Go to dashboard">
            <span class="brand-mark">P</span>
            <span class="brand-text">Planner</span>
          </a>

          <nav class="desktop-nav" aria-label="Primary navigation">
            <a href="/" class="nav-link" data-nav-link>Dashboard</a>
            <a href="/calendar" class="nav-link" data-nav-link>12-Month Planner</a>
            <a href="/cvm" class="nav-link" data-nav-link>CVM View</a>
            <a href="/customers" class="nav-link" data-nav-link>Customers</a>
            <a href="/products" class="nav-link" data-nav-link>Products</a>
            <a href="/import" class="nav-link" data-nav-link>Import Workbook</a>
          </nav>

          <button
            id="menu-button"
            type="button"
            class="menu-button"
            aria-label="Open menu"
            aria-controls="side-sheet"
            aria-expanded="false"
          >
            Menu
          </button>

          <div class="header-actions">
            <details class="import-menu header-import">
              <summary class="button-secondary action-button import-trigger">Import</summary>
              <div class="import-menu-panel" role="menu" aria-label="Import options">
                <a href="/import" role="menuitem">Import Workbook</a>
                <a href="/import#summary" role="menuitem">View Last Summary</a>
              </div>
            </details>
            <a href="/cvm" class="button-primary action-button header-new-visit">New Visit</a>
            <button id="theme-toggle" type="button" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
              <span class="icon-moon" aria-hidden="true">&#9789;</span>
              <span class="icon-sun" aria-hidden="true">&#9728;</span>
            </button>
            <button type="button" class="user-chip" aria-label="User menu placeholder">A</button>
          </div>
        </div>
      </header>

      <div id="side-sheet" class="side-sheet" aria-hidden="true">
        <button type="button" class="sheet-overlay" aria-label="Close menu"></button>
        <aside class="sheet-panel" role="dialog" aria-modal="true" aria-label="Navigation menu">
          <div class="sheet-head">
            <p>Navigation</p>
            <button id="sheet-close" type="button" class="sheet-close" aria-label="Close menu">Close</button>
          </div>
          <nav class="sheet-nav" aria-label="Mobile navigation">
            <a href="/" class="nav-link" data-nav-link>Dashboard</a>
            <a href="/calendar" class="nav-link" data-nav-link>12-Month Planner</a>
            <a href="/cvm" class="nav-link" data-nav-link>CVM View</a>
            <a href="/customers" class="nav-link" data-nav-link>Customers</a>
            <a href="/products" class="nav-link" data-nav-link>Products</a>
            <a href="/import" class="nav-link" data-nav-link>Import Workbook</a>
          </nav>
          <div class="sheet-actions">
            <a href="/import" class="button-secondary action-button">Import Workbook</a>
            <a href="/cvm" class="button-primary action-button">New Visit</a>
          </div>
        </aside>
      </div>

      <main class="app-main">
        {% block page_header %}{% endblock %}
        {% block content %}{% endblock %}
      </main>
    </div>

    <script>
      (() => {
        const path = window.location.pathname;
        document.querySelectorAll("[data-nav-link]").forEach((link) => {
          const href = link.getAttribute("href") || "";
          const active = path === href || (href !== "/" && path.startsWith(href));
          if (active) link.classList.add("is-active");
        });

        const sheet = document.getElementById("side-sheet");
        const openBtn = document.getElementById("menu-button");
        const closeBtn = document.getElementById("sheet-close");
        const overlay = sheet ? sheet.querySelector(".sheet-overlay") : null;

        if (!sheet || !openBtn || !closeBtn || !overlay) {
          return;
        }

        const open = () => {
          sheet.classList.add("open");
          sheet.setAttribute("aria-hidden", "false");
          openBtn.setAttribute("aria-expanded", "true");
          document.body.classList.add("sheet-open");
        };

        const close = () => {
          sheet.classList.remove("open");
          sheet.setAttribute("aria-hidden", "true");
          openBtn.setAttribute("aria-expanded", "false");
          document.body.classList.remove("sheet-open");
        };

        openBtn.addEventListener("click", open);
        closeBtn.addEventListener("click", close);
        overlay.addEventListener("click", close);

        sheet.querySelectorAll("a").forEach((a) => {
          a.addEventListener("click", close);
        });

        window.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && sheet.classList.contains("open")) {
            close();
          }
        });

        const importMenu = document.querySelector(".import-menu");
        if (importMenu) {
          window.addEventListener("click", (event) => {
            if (!importMenu.contains(event.target)) {
              importMenu.removeAttribute("open");
            }
          });
        }

        const params = new URLSearchParams(window.location.search);
        if (params.has("debug_overflow")) {
          const scanOverflow = () => {
            const viewport = document.documentElement.clientWidth;
            const offenders = [];
            document.querySelectorAll("body *").forEach((el) => {
              const rect = el.getBoundingClientRect();
              if (rect.width > viewport + 1 || rect.right > viewport + 1 || rect.left < -1) {
                offenders.push({ node: el, width: Math.round(rect.width), left: Math.round(rect.left), right: Math.round(rect.right) });
              }
            });
            if (offenders.length) {
              console.group("Overflow debug");
              offenders.slice(0, 24).forEach((item) => console.log(item));
              console.groupEnd();
            } else {
              console.log("Overflow debug: no wide elements found.");
            }
          };
          window.addEventListener("load", scanOverflow);
          window.addEventListener("resize", scanOverflow);
        }

        const themeToggle = document.getElementById("theme-toggle");
        const themeKey = "planner.theme";
        const applyTheme = (theme) => {
          const nextTheme = theme === "dark" ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", nextTheme);
          document.documentElement.classList.toggle("dark", nextTheme === "dark");
          if (themeToggle) {
            themeToggle.setAttribute("aria-label", nextTheme === "dark" ? "Switch to light mode" : "Switch to dark mode");
            themeToggle.setAttribute("title", nextTheme === "dark" ? "Switch to light mode" : "Switch to dark mode");
          }
        };

        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const current = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            try {
              window.localStorage.setItem(themeKey, next);
            } catch (_) {}
            applyTheme(next);
          });
          applyTheme(document.documentElement.getAttribute("data-theme"));
        }
      })();
    </script>
  </body>
</html>
